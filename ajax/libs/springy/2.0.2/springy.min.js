(function(){var h=this;var j;if(typeof exports!=="undefined"){j=exports}else{j=h.Springy={}}var g=j.Graph=function(){this.nodeSet={};this.nodes=[];this.edges=[];this.adjacency={};this.nextNodeId=0;this.nextEdgeId=0;this.eventListeners=[]};var f=j.Node=function(l,k){this.id=l;this.data=(k!==undefined)?k:{}};var d=j.Edge=function(n,l,m,k){this.id=n;this.source=l;this.target=m;this.data=(k!==undefined)?k:{}};g.prototype.addNode=function(k){if(!(k.id in this.nodeSet)){this.nodes.push(k)}this.nodeSet[k.id]=k;this.notify();return k};g.prototype.addNodes=function(){for(var l=0;l<arguments.length;l++){var k=arguments[l];var m=new f(k,{label:k});this.addNode(m)}};g.prototype.addEdge=function(l){var k=false;this.edges.forEach(function(m){if(l.id===m.id){k=true}});if(!k){this.edges.push(l)}if(!(l.source.id in this.adjacency)){this.adjacency[l.source.id]={}}if(!(l.target.id in this.adjacency[l.source.id])){this.adjacency[l.source.id][l.target.id]=[]}k=false;this.adjacency[l.source.id][l.target.id].forEach(function(m){if(l.id===m.id){k=true}});if(!k){this.adjacency[l.source.id][l.target.id].push(l)}this.notify();return l};g.prototype.addEdges=function(){for(var n=0;n<arguments.length;n++){var o=arguments[n];var m=this.nodeSet[o[0]];if(m==undefined){throw new TypeError("invalid node name: "+o[0])}var l=this.nodeSet[o[1]];if(l==undefined){throw new TypeError("invalid node name: "+o[1])}var k=o[2];this.newEdge(m,l,k)}};g.prototype.newNode=function(l){var k=new f(this.nextNodeId++,l);this.addNode(k);return k};g.prototype.newEdge=function(m,n,l){var k=new d(this.nextEdgeId++,m,n,l);this.addEdge(k);return k};g.prototype.loadJSON=function(k){if(typeof k=="string"||k instanceof String){k=JSON.parse(k)}if("nodes" in k||"edges" in k){this.addNodes.apply(this,k.nodes);this.addEdges.apply(this,k.edges)}};g.prototype.getEdges=function(l,k){if(l.id in this.adjacency&&k.id in this.adjacency[l.id]){return this.adjacency[l.id][k.id]}return[]};g.prototype.removeNode=function(l){if(l.id in this.nodeSet){delete this.nodeSet[l.id]}for(var k=this.nodes.length-1;k>=0;k--){if(this.nodes[k].id===l.id){this.nodes.splice(k,1)}}this.detachNode(l)};g.prototype.detachNode=function(k){var l=this.edges.slice();l.forEach(function(m){if(m.source.id===k.id||m.target.id===k.id){this.removeEdge(m)}},this);this.notify()};g.prototype.removeEdge=function(o){for(var n=this.edges.length-1;n>=0;n--){if(this.edges[n].id===o.id){this.edges.splice(n,1)}}for(var k in this.adjacency){for(var p in this.adjacency[k]){var l=this.adjacency[k][p];for(var m=l.length-1;m>=0;m--){if(this.adjacency[k][p][m].id===o.id){this.adjacency[k][p].splice(m,1)}}if(this.adjacency[k][p].length==0){delete this.adjacency[k][p]}}if(b(this.adjacency[k])){delete this.adjacency[k]}}this.notify()};g.prototype.merge=function(l){var k=[];l.nodes.forEach(function(m){k.push(this.addNode(new f(m.id,m.data)))},this);l.edges.forEach(function(n){var q=k[n.from];var p=k[n.to];var o=(n.directed)?(o=n.type+"-"+q.id+"-"+p.id):(q.id<p.id)?n.type+"-"+q.id+"-"+p.id:n.type+"-"+p.id+"-"+q.id;var m=this.addEdge(new d(o,q,p,n.data));m.data.type=n.type},this)};g.prototype.filterNodes=function(k){var l=this.nodes.slice();l.forEach(function(m){if(!k(m)){this.removeNode(m)}},this)};g.prototype.filterEdges=function(k){var l=this.edges.slice();l.forEach(function(m){if(!k(m)){this.removeEdge(m)}},this)};g.prototype.addGraphListener=function(k){this.eventListeners.push(k)};g.prototype.notify=function(){this.eventListeners.forEach(function(k){k.graphChanged()})};var i=j.Layout={};i.ForceDirected=function(n,k,l,m){this.graph=n;this.stiffness=k;this.repulsion=l;this.damping=m;this.nodePoints={};this.edgeSprings={}};i.ForceDirected.prototype.point=function(l){if(!(l.id in this.nodePoints)){var k=(l.data.mass!==undefined)?l.data.mass:1;this.nodePoints[l.id]=new i.ForceDirected.Point(c.random(),k)}return this.nodePoints[l.id]};i.ForceDirected.prototype.spring=function(l){if(!(l.id in this.edgeSprings)){var k=(l.data.length!==undefined)?l.data.length:1;var m=false;var o=this.graph.getEdges(l.source,l.target);o.forEach(function(p){if(m===false&&p.id in this.edgeSprings){m=this.edgeSprings[p.id]}},this);if(m!==false){return new i.ForceDirected.Spring(m.point1,m.point2,0,0)}var n=this.graph.getEdges(l.target,l.source);o.forEach(function(p){if(m===false&&p.id in this.edgeSprings){m=this.edgeSprings[p.id]}},this);if(m!==false){return new i.ForceDirected.Spring(m.point2,m.point1,0,0)}this.edgeSprings[l.id]=new i.ForceDirected.Spring(this.point(l.source),this.point(l.target),k,this.stiffness)}return this.edgeSprings[l.id]};i.ForceDirected.prototype.eachNode=function(l){var k=this;this.graph.nodes.forEach(function(m){l.call(k,m,k.point(m))})};i.ForceDirected.prototype.eachEdge=function(l){var k=this;this.graph.edges.forEach(function(m){l.call(k,m,k.spring(m))})};i.ForceDirected.prototype.eachSpring=function(l){var k=this;this.graph.edges.forEach(function(m){l.call(k,k.spring(m))})};i.ForceDirected.prototype.applyCoulombsLaw=function(){this.eachNode(function(l,k){this.eachNode(function(n,m){if(k!==m){var p=k.p.subtract(m.p);var q=p.magnitude()+0.1;var o=p.normalise();k.applyForce(o.multiply(this.repulsion).divide(q*q*0.5));m.applyForce(o.multiply(this.repulsion).divide(q*q*-0.5))}})})};i.ForceDirected.prototype.applyHookesLaw=function(){this.eachSpring(function(k){var n=k.point2.p.subtract(k.point1.p);var l=k.length-n.magnitude();var m=n.normalise();k.point1.applyForce(m.multiply(k.k*l*-0.5));k.point2.applyForce(m.multiply(k.k*l*0.5))})};i.ForceDirected.prototype.attractToCentre=function(){this.eachNode(function(l,k){var m=k.p.multiply(-1);k.applyForce(m.multiply(this.repulsion/50))})};i.ForceDirected.prototype.updateVelocity=function(k){this.eachNode(function(m,l){l.v=l.v.add(l.a.multiply(k)).multiply(this.damping);l.a=new c(0,0)})};i.ForceDirected.prototype.updatePosition=function(k){this.eachNode(function(m,l){l.p=l.p.add(l.v.multiply(k))})};i.ForceDirected.prototype.totalEnergy=function(k){var l=0;this.eachNode(function(n,m){var o=m.v.magnitude();l+=0.5*m.m*o*o});return l};var e=function(k,l){return function(){return k.apply(l,arguments)}};j.requestAnimationFrame=e(h.requestAnimationFrame||h.webkitRequestAnimationFrame||h.mozRequestAnimationFrame||h.oRequestAnimationFrame||h.msRequestAnimationFrame||(function(l,k){h.setTimeout(l,10)}),h);i.ForceDirected.prototype.start=function(m,k){var l=this;if(this._started){return}this._started=true;this._stop=false;j.requestAnimationFrame(function n(){l.applyCoulombsLaw();l.applyHookesLaw();l.attractToCentre();l.updateVelocity(0.03);l.updatePosition(0.03);if(m!==undefined){m()}if(l._stop||l.totalEnergy()<0.01){l._started=false;if(k!==undefined){k()}}else{j.requestAnimationFrame(n)}})};i.ForceDirected.prototype.stop=function(){this._stop=true};i.ForceDirected.prototype.nearest=function(m){var l={node:null,point:null,distance:null};var k=this;this.graph.nodes.forEach(function(q){var o=k.point(q);var p=o.p.subtract(m).magnitude();if(l.distance===null||p<l.distance){l={node:q,point:o,distance:p}}});return l};i.ForceDirected.prototype.getBoundingBox=function(){var k=new c(-2,-2);var m=new c(2,2);this.eachNode(function(p,o){if(o.p.x<k.x){k.x=o.p.x}if(o.p.y<k.y){k.y=o.p.y}if(o.p.x>m.x){m.x=o.p.x}if(o.p.y>m.y){m.y=o.p.y}});var l=m.subtract(k).multiply(0.07);return{bottomleft:k.subtract(l),topright:m.add(l)}};var c=j.Vector=function(k,l){this.x=k;this.y=l};c.random=function(){return new c(10*(Math.random()-0.5),10*(Math.random()-0.5))};c.prototype.add=function(k){return new c(this.x+k.x,this.y+k.y)};c.prototype.subtract=function(k){return new c(this.x-k.x,this.y-k.y)};c.prototype.multiply=function(k){return new c(this.x*k,this.y*k)};c.prototype.divide=function(k){return new c((this.x/k)||0,(this.y/k)||0)};c.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};c.prototype.normal=function(){return new c(-this.y,this.x)};c.prototype.normalise=function(){return this.divide(this.magnitude())};i.ForceDirected.Point=function(k,l){this.p=k;this.m=l;this.v=new c(0,0);this.a=new c(0,0)};i.ForceDirected.Point.prototype.applyForce=function(k){this.a=this.a.add(k.divide(this.m))};i.ForceDirected.Spring=function(n,m,o,l){this.point1=n;this.point2=m;this.length=o;this.k=l};var a=j.Renderer=function(n,k,m,l){this.layout=n;this.clear=k;this.drawEdge=m;this.drawNode=l;this.layout.graph.addGraphListener(this)};a.prototype.graphChanged=function(k){this.start()};a.prototype.start=function(){var k=this;this.layout.start(function l(){k.clear();k.layout.eachEdge(function(n,m){k.drawEdge(n,m.point1.p,m.point2.p)});k.layout.eachNode(function(n,m){k.drawNode(n,m.p)})})};a.prototype.stop=function(){this.layout.stop()};if(!Array.prototype.forEach){Array.prototype.forEach=function(r,m){var o,n;if(this==null){throw new TypeError(" this is null or not defined")}var q=Object(this);var l=q.length>>>0;if({}.toString.call(r)!="[object Function]"){throw new TypeError(r+" is not a function")}if(m){o=m}n=0;while(n<l){var p;if(n in q){p=q[n];r.call(o,p,n,q)}n++}}}var b=function(m){for(var l in m){if(m.hasOwnProperty(l)){return false}}return true}}).call(this);