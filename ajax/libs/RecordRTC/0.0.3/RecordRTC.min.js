function RecordRTC(e,o){if(o=o||{},!e)throw"MediaStream is mandatory.";function i(e,t){if(!e)throw"Pass a callback function over getDataURL.";var o=new FileReader;o.readAsDataURL(t?t.recordedBlob:r.recordedBlob),o.onload=function(t){e(t.target.result)}}o.type||(o.type="audio");var r,n='It seems that "startRecording" is not invoked for '+o.type+" recorder.";return{startRecording:function(){console.debug("started recording "+o.type+" stream.");var t=IsChrome?window.StereoRecorder:window.MediaStreamRecorder;return"video"==o.type&&(t=window.WhammyRecorder),"gif"==o.type&&(t=window.GifRecorder),"canvas"==o.type&&(t=window.CanvasRecorder),(r=mergeProps(r=new t(e),o)).record(),this},stopRecording:function(t){if(!r)return console.warn(n);console.warn("stopped recording "+o.type+" stream."),r.stop(),t&&r&&t(URL.createObjectURL(r.recordedBlob)),o.autoWriteToDisk&&i(function(t){var e={};e[o.type+"Blob"]=t,DiskStorage.Store(e)})},getBlob:function(){return r?r.recordedBlob:console.warn(n)},getDataURL:i,toURL:function(){return r?URL.createObjectURL(r.recordedBlob):console.warn(n)},save:function(){if(!r)return console.warn(n);console.log("saving recorded "+o.type+" stream to disk!"),this.getDataURL(function(t){var e=document.createElement("a");e.href=t,e.target="_blank",e.download=Math.round(9999999999*Math.random())+888888888+"."+r.recordedBlob.type.split("/")[1];var o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(o),(window.URL||window.webkitURL).revokeObjectURL(e.href)})},getFromDisk:function(t){if(!r)return console.warn(n);RecordRTC.getFromDisk(o.type,t)}}}function mergeProps(t,e){for(var o in e=reformatProps(e))"function"!=typeof e[o]&&(t[o]=e[o]);return t}function reformatProps(t){var e={};for(var o in t)if(-1!=o.indexOf("-")){var i=o.split("-");e[i[0]+i[1].split("")[0].toUpperCase()+i[1].substr(1)]=t[o]}else e[o]=t[o];return e}function MediaStreamRecorder(t){var e,o=this;this.record=function(){(e=new MediaRecorder(t)).ondataavailable=function(t){o.recordedBlob?o.recordedBlob=new Blob([o.recordedBlob,t.data],{type:"audio/ogg"}):o.recordedBlob=new Blob([t.data],{type:"audio/ogg"})},e.start(0)},this.stop=function(){"recording"==e.state&&(e.requestData(),e.stop())}}function StereoRecorder(t){var e;this.record=function(){(e=new StereoAudioRecorder(t,this)).record()},this.stop=function(){e&&e.stop(),this.recordedBlob=e.recordedBlob}}RecordRTC.getFromDisk=function(o,i){if(!i)throw"callback is mandatory.";console.log("Getting recorded "+("all"==o?"blobs":o+" blob ")+" from disk!"),DiskStorage.Fetch(function(t,e){"all"!=o&&e==o+"Blob"&&i&&i(t),"all"==o&&i&&i(t,e.replace("Blob",""))})},RecordRTC.writeToDisk=function(t){console.log("Writing recorded blob(s) to disk!"),(t=t||{}).audio&&t.video&&t.gif?t.audio.getDataURL(function(o){t.video.getDataURL(function(e){t.gif.getDataURL(function(t){DiskStorage.Store({audioBlob:o,videoBlob:e,gifBlob:t})})})}):t.audio&&t.video?t.audio.getDataURL(function(e){t.video.getDataURL(function(t){DiskStorage.Store({audioBlob:e,videoBlob:t})})}):t.audio&&t.gif?t.audio.getDataURL(function(e){t.gif.getDataURL(function(t){DiskStorage.Store({audioBlob:e,gifBlob:t})})}):t.video&&t.gif?t.video.getDataURL(function(e){t.gif.getDataURL(function(t){DiskStorage.Store({videoBlob:e,gifBlob:t})})}):t.audio?t.audio.getDataURL(function(t){DiskStorage.Store({audioBlob:t})}):t.video?t.video.getDataURL(function(t){DiskStorage.Store({videoBlob:t})}):t.gif&&t.gif.getDataURL(function(t){DiskStorage.Store({gifBlob:t})})},requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame,cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame,AudioContext=window.webkitAudioContext||window.mozAudioContext,URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia,window.webkitMediaStream&&(window.MediaStream=window.webkitMediaStream),IsChrome=!!navigator.webkitGetUserMedia;var __stereoAudioRecorderJavacriptNode,isWebPSupported,Storage={AudioContext:window.AudioContext||window.webkitAudioContext};function StereoAudioRecorder(t,e){var a=[],d=[],c=!1,s=0;function u(t,e){for(var o=new Float32Array(e),i=0,r=t.length,n=0;n<r;n++){var a=t[n];o.set(a,i),i+=a.length}return o}function f(t,e,o){for(var i=o.length,r=0;r<i;r++)t.setUint8(e+r,o.charCodeAt(r))}this.record=function(){c=!0,a.length=d.length=0,s=0},this.stop=function(){c=!1;var t=function(t,e){for(var o=t.length+e.length,i=new Float32Array(o),r=0,n=0;n<o;)i[n++]=t[r],i[n++]=e[r],r++;return i}(u(a,s),u(d,s)),e=new ArrayBuffer(44+2*t.length),o=new DataView(e);f(o,0,"RIFF"),o.setUint32(4,44+2*t.length,!0),f(o,8,"WAVE"),f(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,2,!0),o.setUint32(24,l,!0),o.setUint32(28,4*l,!0),o.setUint16(32,4,!0),o.setUint16(34,16,!0),f(o,36,"data"),o.setUint32(40,2*t.length,!0);var i=t.length,r=44;h=1;for(var n=0;n<i;n++)o.setInt16(r,t[n]*(32767*h),!0),r+=2;this.recordedBlob=new Blob([o],{type:"audio/wav"}),this.length=s};var o=Storage.AudioContext;Storage.AudioContextConstructor||(Storage.AudioContextConstructor=new o);var i=Storage.AudioContextConstructor;Storage.VolumeGainNode||(Storage.VolumeGainNode=i.createGain());var h=Storage.VolumeGainNode;Storage.AudioInput||(Storage.AudioInput=i.createMediaStreamSource(t)),Storage.AudioInput.connect(h);var r=[256,512,1024,2048,4096,8192,16384],n=e.bufferSize||4096;if(-1==r.indexOf(n))throw"Legal values for buffer-size are "+JSON.stringify(r,null,"\t");var l=e.sampleRate||i.sampleRate||44100;if(l<22050||96e3<l)throw"sample-rate must be under range 22050 and 96000.";if(console.log("sample-rate",l),console.log("buffer-size",n),i.createJavaScriptNode)__stereoAudioRecorderJavacriptNode=i.createJavaScriptNode(n,2,2);else{if(!i.createScriptProcessor)throw"WebAudio API has no support on this browser.";__stereoAudioRecorderJavacriptNode=i.createScriptProcessor(n,2,2)}__stereoAudioRecorderJavacriptNode.onaudioprocess=function(t){if(c){var e=t.inputBuffer.getChannelData(0),o=t.inputBuffer.getChannelData(1);a.push(new Float32Array(e)),d.push(new Float32Array(o)),s+=n}},h.connect(__stereoAudioRecorderJavacriptNode),__stereoAudioRecorderJavacriptNode.connect(i.destination)}function WhammyRecorder(t){isWebPSupported||console.error("It seems that webp images are not supported in this browser. Please try chrome."),this.record=function(){function e(t){a=requestAnimationFrame(e),void 0===typeof n&&(n=t),t-n<90||(i.drawImage(r,0,0,o.width,o.height),d.add(o),n=t)}this.width||(this.width=r.offsetWidth||320),this.height||(this.height=r.offsetHeight||240),this.video||(this.video={width:this.width,height:this.height}),this.canvas||(this.canvas={width:this.width,height:this.height}),o.width=this.canvas.width,o.height=this.canvas.height,r.width=this.video.width,r.height=this.video.height,Date.now(),setTimeout(function(){a=requestAnimationFrame(e)},500)},this.stop=function(){a&&cancelAnimationFrame(a),Date.now(),this.recordedBlob=d.compile(),d.frames=[]};var o=document.createElement("canvas"),i=o.getContext("2d"),r=document.createElement("video");r.muted=!0,r.volume=0,r.autoplay=!0,r.src=URL.createObjectURL(t),r.play();var n,a=null,d=new Whammy.Video}function CanvasRecorder(t){if(!window.html2canvas)throw"Please link: //www.webrtc-experiment.com/screenshot.js";var e;function o(){html2canvas(t,{onrendered:function(t){i.add(t),e&&requestAnimationFrame(o)}})}this.record=function(){e=!0,o()},this.stop=function(){e=!1,this.recordedBlob=i.compile(),i.frames=[]};var i=new Whammy.Video}function GifRecorder(t){this.record=function(){this.width||(this.width=r.offsetWidth||320),this.height||(this.height=r.offsetHeight||240),this.video||(this.video={width:this.width,height:this.height}),this.canvas||(this.canvas={width:this.width,height:this.height}),o.width=this.canvas.width,o.height=this.canvas.height,r.width=this.video.width,r.height=this.video.height,(a=new GIFEncoder).setRepeat(0),a.setDelay(this.frameRate||200),a.setQuality(this.quality||10),a.start(),Date.now(),d=requestAnimationFrame(function t(e){d=requestAnimationFrame(t),void 0===typeof n&&(n=e),e-n<90||(i.drawImage(r,0,0,o.width,o.height),a.addFrame(i),n=e)})},this.stop=function(){d&&cancelAnimationFrame(d),Date.now(),this.recordedBlob=new Blob([new Uint8Array(a.stream().bin)],{type:"image/gif"}),a.stream().bin=[]};var o=document.createElement("canvas"),i=o.getContext("2d"),r=document.createElement("video");r.muted=!0,r.autoplay=!0,r.src=URL.createObjectURL(t),r.play();var n,a,d=null}!function(t){var e=new Image;e.addEventListener("load",function(){2===this.width&&1===this.height?t(!0):t(!1)}),e.addEventListener("error",function(){t(!1)}),e.src="data:image/webp;base64,UklGRjIAAABXRUJQVlA4ICYAAACyAgCdASoCAAEALmk0mk0iIiIiIgBoSygABc6zbAAA/v56QAAAAA=="}(function(t){isWebPSupported=t});var Whammy=function(){function t(t){for(var e,o=function(t){if(!t[0])return void console.warn("Something went wrong. Maybe WebP format is not supported in the current browser.");for(var e=t[0].width,o=t[0].height,i=t[0].duration,r=1;r<t.length;r++)i+=t[r].duration;return{duration:i,width:e,height:o}}(t),i=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:(e=o.duration,[].slice.call(new Uint8Array(new Float64Array([e]).buffer),0).map(function(t){return String.fromCharCode(t)}).reverse().join("")),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:25541},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:o.width,id:176},{data:o.height,id:186}]}]}]}]}],r=0,n=0;r<t.length;){for(var a=[],d=0;a.push(t[r]),d+=t[r].duration,++r<t.length&&d<3e4;);var c=0,s={id:524531317,data:[{data:n,id:231}].concat(a.map(function(t){var e=h({discardable:0,frame:t.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(c)});return c+=t.duration,{data:e,id:163}}))};i[1].data.push(s),n+=d}return function t(e){var o=[];for(var i=0;i<e.length;i++){var r=e[i].data;if("object"==typeof r&&(r=t(r)),"number"==typeof r&&(r=f(r.toString(2))),"string"==typeof r&&(r=new Uint8Array(r.split("").map(function(t){return t.charCodeAt(0)}))),r.length);var n=r.size||r.byteLength||r.length,a=Math.ceil(Math.ceil(Math.log(n)/Math.log(2))/8),d=n.toString(2),c=new Array(7*a+7+1-d.length).join("0")+d,s=new Array(a).join("0")+"1"+c;o.push(u(e[i].id)),o.push(f(s)),o.push(r)}return new Blob(o,{type:"video/webm"})}(i)}function u(t){for(var e=[];0<t;)e.push(255&t),t>>=8;return new Uint8Array(e.reverse())}function f(t){var e=[];t=(t.length%8?new Array(9-t.length%8).join("0"):"")+t;for(var o=0;o<t.length;o+=8)e.push(parseInt(t.substr(o,8),2));return new Uint8Array(e)}function h(t){var e=0;if(t.keyframe&&(e|=128),t.invisible&&(e|=8),t.lacing&&(e|=t.lacing<<1),t.discardable&&(e|=1),127<t.trackNum)throw"TrackNumber > 127 not supported";return[128|t.trackNum,t.timecode>>8,255&t.timecode,e].map(function(t){return String.fromCharCode(t)}).join("")+t.frame}function e(){this.frames=[],this.duration=130,this.quality=.8}return e.prototype.add=function(t,e){if(void 0!==e&&this.duration)throw"you can't pass a duration if the fps is set";if(void 0===e&&!this.duration)throw"if you don't have the fps set, you ned to have durations here.";if("canvas"in t&&(t=t.canvas),"toDataURL"in t)t=t.toDataURL("image/webp",this.quality);else if("string"!=typeof t)throw"frame must be a a HTMLCanvasElement, a CanvasRenderingContext2D or a DataURI formatted string";if(!/^data:image\/webp;base64,/gi.test(t))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:t,duration:e||this.duration})},e.prototype.compile=function(){return new t(this.frames.map(function(t){var e=function(t){for(var e,o,i=t.RIFF[0].WEBP[0],r=i.indexOf("¬ù*"),n=0,a=[];n<4;n++)a[n]=i.charCodeAt(r+3+n);return e=16383&(o=a[1]<<8|a[0]),o=a[3]<<8|a[2],{width:e,height:16383&o,data:i,riff:t}}(function t(e){for(var o=0,i={};o<e.length;){var r=e.substr(o,4),n=parseInt(e.substr(o+4,4).split("").map(function(t){var e=t.charCodeAt(0).toString(2);return new Array(8-e.length+1).join("0")+e}).join(""),2),a=e.substr(o+4+4,n);o+=8+n,i[r]=i[r]||[],"RIFF"==r||"LIST"==r?i[r].push(t(a)):i[r].push(a)}return i}(atob(t.image.slice(23))));return e.duration=t.duration,e}))},{Video:e,toWebM:t}}(),DiskStorage={init:function(){var o,i=this,t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.OIndexedDB||window.msIndexedDB,e=location.href.replace(/\/|:|#|%|\.|\[|\]/g,""),r=t.open(e,1);function n(t){t.createObjectStore(i.dataStoreName)}function a(){var t=o.transaction([i.dataStoreName],"readwrite");function e(e){t.objectStore(i.dataStoreName).get(e).onsuccess=function(t){i.callback&&i.callback(t.target.result,e)}}i.videoBlob&&t.objectStore(i.dataStoreName).put(i.videoBlob,"videoBlob"),i.gifBlob&&t.objectStore(i.dataStoreName).put(i.gifBlob,"gifBlob"),i.audioBlob&&t.objectStore(i.dataStoreName).put(i.audioBlob,"audioBlob"),e("audioBlob"),e("videoBlob"),e("gifBlob")}r.onerror=i.onError,r.onsuccess=function(){((o=r.result).onerror=i.onError,o.setVersion)?1!=o.version?o.setVersion(1).onsuccess=function(){n(o),a()}:a():a()},r.onupgradeneeded=function(t){n(t.target.result)}},Fetch:function(t){return this.callback=t,this.init(),this},Store:function(t){return this.audioBlob=t.audioBlob,this.videoBlob=t.videoBlob,this.gifBlob=t.gifBlob,this.init(),this},onError:function(t){console.error(JSON.stringify(t,null,"\t"))},dataStoreName:"recordRTC"};function MRecordRTC(e){this.addStream=function(t){t&&(e=t)},this.mediaType={audio:!0,video:!0},this.startRecording=function(){this.mediaType.audio&&(this.audioRecorder=RecordRTC(e,this).startRecording()),this.mediaType.video&&(this.videoRecorder=RecordRTC(e,mergeProps(this,{type:"video"})).startRecording()),this.mediaType.gif&&(this.gifRecorder=RecordRTC(e,mergeProps(this,{type:"gif"})).startRecording())},this.stopRecording=function(e){e=e||function(){},this.audioRecorder&&this.audioRecorder.stopRecording(function(t){e(t,"audio")}),this.videoRecorder&&this.videoRecorder.stopRecording(function(t){e(t,"video")}),this.gifRecorder&&this.gifRecorder.stopRecording(function(t){e(t,"gif")})},this.getBlob=function(t){var e={};this.audioRecorder&&(e.audio=this.audioRecorder.getBlob()),this.videoRecorder&&(e.video=this.videoRecorder.getBlob()),this.gifRecorder&&(e.gif=this.gifRecorder.getBlob()),t&&t(e)},this.writeToDisk=function(){RecordRTC.writeToDisk({audio:this.audioRecorder,video:this.videoRecorder,gif:this.gifRecorder})}}function encode64(t){for(var e,o,i,r,n,a,d,c="",s=0,u=t.length,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";s<u;)r=(e=t.charCodeAt(s++))>>2,n=(3&e)<<4|(o=t.charCodeAt(s++))>>4,a=(15&o)<<2|(i=t.charCodeAt(s++))>>6,d=63&i,isNaN(o)?a=d=64:isNaN(i)&&(d=64),c=c+f.charAt(r)+f.charAt(n)+f.charAt(a)+f.charAt(d);return c}MRecordRTC.getFromDisk=RecordRTC.getFromDisk,MRecordRTC.writeToDisk=RecordRTC.writeToDisk,LZWEncoder=function(){var r,n,a,d,e,o,s,u,f,h,l,g,t={},w=[],v=[],m=0,p=!1,i=0,c=0,b=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],y=[],R=t.LZWEncoder=function(t,e,o,i){r=t,n=e,a=o,d=Math.max(2,i)},B=function(t,e){y[g++]=t,254<=g&&C(e)},A=function(t){for(var e=0;e<t;++e)w[e]=-1},S=t.compress=function(t,e){var o,i,r,n,a,d,c;for(p=!1,u=D(s=f=t),l=(h=1<<t-1)+1,m=h+2,g=0,n=U(),d=0,o=5003;o<65536;o*=2)++d;d=8-d,A(5003),k(h,e);t:for(;-1!=(r=U());)if(o=(r<<12)+n,w[i=r<<d^n]!=o){if(0<=w[i]){a=5003-i,0==i&&(a=1);do{if((i-=a)<0&&(i+=5003),w[i]==o){n=v[i];continue t}}while(0<=w[i])}k(n,e),n=r,m<4096?(v[i]=m++,w[i]=o):(c=e,A(5003),m=h+2,p=!0,k(h,c))}else n=v[i];k(n,e),k(l,e)},C=(t.encode=function(t){t.writeByte(d),e=r*n,o=0,S(d+1,t),t.writeByte(0)},function(t){0<g&&(t.writeByte(g),t.writeBytes(y,0,g),g=0)}),D=function(t){return(1<<t)-1},U=function(){return 0==e?-1:(--e,255&a[o++])},k=function(t,e){for(i&=b[c],0<c?i|=t<<c:i=t,c+=s;8<=c;)B(255&i,e),i>>=8,c-=8;if((u<m||p)&&(p?(u=D(s=f),p=!1):u=12==++s?4096:D(s)),t==l){for(;0<c;)B(255&i,e),i>>=8,c-=8;C(e)}};return R.apply(this,arguments),t},NeuQuant=function(){var g,w,v,m,l,t={},p=256,h=1<<18,u=[],b=[],y=[],R=[],e=t.NeuQuant=function(t,e,o){var i,r;for(w=t,v=e,m=o,l=new Array(p),i=0;i<p;i++)l[i]=new Array(4),(r=l[i])[0]=r[1]=r[2]=(i<<12)/p,y[i]=256,b[i]=0},o=(t.map=function(t,e,o){var i,r,n,a,d,c,s;for(d=1e3,s=-1,r=(i=u[e])-1;i<p||0<=r;)i<p&&(d<=(n=(c=l[i])[1]-e)?i=p:(i++,n<0&&(n=-n),(a=c[0]-t)<0&&(a=-a),(n+=a)<d&&((a=c[2]-o)<0&&(a=-a),(n+=a)<d&&(d=n,s=c[3])))),0<=r&&(d<=(n=e-(c=l[r])[1])?r=-1:(r--,n<0&&(n=-n),(a=c[0]-t)<0&&(a=-a),(n+=a)<d&&((a=c[2]-o)<0&&(a=-a),(n+=a)<d&&(d=n,s=c[3]))));return s},t.process=function(){return function(){var t,e,o,i,r,n,a,d,c,s,u,f,h,l;for(v<1509&&(m=1),g=30+(m-1)/3,f=w,s=(u=(l=v)/(3*m))/100|(h=0),d=1024,(a=(n=2048)>>6)<=1&&(a=0),t=0;t<a;t++)R[t]=d*(256*(a*a-t*t)/(a*a));for(c=v<1509?3:v%499!=0?1497:v%491!=0?1473:v%487!=0?1461:1509,t=0;t<u;)if(o=(255&f[h+0])<<4,i=(255&f[h+1])<<4,r=(255&f[h+2])<<4,e=S(o,i,r),A(d,e,o,i,r),0!=a&&B(a,e,o,i,r),l<=(h+=c)&&(h-=v),0==s&&(s=1),++t%s==0)for(d-=d/g,(a=(n-=n/30)>>6)<=1&&(a=0),e=0;e<a;e++)R[e]=d*(256*(a*a-e*e)/(a*a))}(),o(),function(){var t,e,o,i,r,n,a,d;for(t=d=a=0;t<p;t++){for(i=(r=l[o=t])[1],e=t+1;e<p;e++)(n=l[e])[1]<i&&(o=e,i=n[1]);if(n=l[o],t!=o&&(e=n[0],n[0]=r[0],r[0]=e,e=n[1],n[1]=r[1],r[1]=e,e=n[2],n[2]=r[2],r[2]=e,e=n[3],n[3]=r[3],r[3]=e),i!=a){for(u[a]=d+t>>1,e=a+1;e<i;e++)u[e]=t;a=i,d=t}}for(u[a]=d+255>>1,e=a+1;e<256;e++)u[e]=255}(),function(){for(var t,e,o,i=[],r=new Array(p),n=0;n<p;n++)r[l[n][3]]=n;for(e=t=0;e<p;e++)o=r[e],i[t++]=l[o][0],i[t++]=l[o][1],i[t++]=l[o][2];return i}()},function(){for(var t=0;t<p;t++)l[t][0]>>=4,l[t][1]>>=4,l[t][2]>>=4,l[t][3]=t}),B=function(t,e,o,i,r){var n,a,d,c,s,u,f;for((d=e-t)<-1&&(d=-1),p<(c=e+t)&&(c=p),n=e+1,a=e-1,u=1;n<c||d<a;){if(s=R[u++],n<c){f=l[n++];try{f[0]-=s*(f[0]-o)/h,f[1]-=s*(f[1]-i)/h,f[2]-=s*(f[2]-r)/h}catch(t){}}if(d<a){f=l[a--];try{f[0]-=s*(f[0]-o)/h,f[1]-=s*(f[1]-i)/h,f[2]-=s*(f[2]-r)/h}catch(t){}}}},A=function(t,e,o,i,r){var n=l[e];n[0]-=t*(n[0]-o)/1024,n[1]-=t*(n[1]-i)/1024,n[2]-=t*(n[2]-r)/1024},S=function(t,e,o){var i,r,n,a,d,c,s,u,f,h;for(f=u=2147483647,s=c=-1,i=0;i<p;i++)(r=(h=l[i])[0]-t)<0&&(r=-r),(n=h[1]-e)<0&&(n=-n),r+=n,(n=h[2]-o)<0&&(n=-n),(r+=n)<u&&(u=r,c=i),(a=r-(b[i]>>12))<f&&(f=a,s=i),d=y[i]>>10,y[i]-=d,b[i]+=d<<10;return y[c]+=64,b[c]-=65536,s};return e.apply(this,arguments),t},GIFEncoder=function(){function t(){this.bin=[]}for(var e=0,i={};e<256;e++)i[e]=String.fromCharCode(e);t.prototype.getData=function(){for(var t="",e=this.bin.length,o=0;o<e;o++)t+=i[this.bin[o]];return t},t.prototype.writeByte=function(t){this.bin.push(t)},t.prototype.writeUTFBytes=function(t){for(var e=t.length,o=0;o<e;o++)this.writeByte(t.charCodeAt(o))},t.prototype.writeBytes=function(t,e,o){for(var i=o||t.length,r=e||0;r<i;r++)this.writeByte(t[r])};var d,c,a,r,s,u,f,h,l,o={},g=null,n=-1,w=0,v=!1,m=[],p=7,b=-1,y=!0,R=!1,B=10,A=(o.setDelay=function(t){w=Math.round(t/10)},o.setDispose=function(t){0<=t&&(b=t)},o.setRepeat=function(t){0<=t&&(n=t)},o.setTransparent=function(t){g=t},o.addFrame=function(t,e){if(null==t||!v||null==r)throw new Error("Please call start method before calling addFrame");var o=!0;try{e?s=t:(s=t.getImageData(0,0,t.canvas.width,t.canvas.height).data,R||S(t.canvas.width,t.canvas.height)),U(),C(),y&&(F(),T(),0<=n&&I()),k(),L(),y||T(),M(),y=!1}catch(t){o=!1}return o},o.finish=function(){if(!v)return!1;var e=!0;v=!1;try{r.writeByte(59)}catch(t){e=!1}return e},function(){l=f=u=s=null,!1,y=!(a=0)}),S=(o.setFrameRate=function(t){15!=t&&(w=Math.round(100/t))},o.setQuality=function(t){t<1&&(t=1),B=t},o.setSize=function(t,e){(!v||y)&&((d=t)<1&&(d=320),(c=e)<1&&(c=240),R=!0)}),C=(o.start=function(){A();var e=!0;!1,r=new t;try{r.writeUTFBytes("GIF89a")}catch(t){e=!1}return v=e},o.cont=function(){A();return!1,r=new t,v=!0},function(){var t,e,o,i,r=u.length,n=r/3;for(f=[],t=new NeuQuant(u,r,B),l=t.process(),o=e=0;o<n;o++)i=t.map(255&u[e++],255&u[e++],255&u[e++]),m[i]=!0,f[o]=i;h=8,p=7,(u=null)!=g&&(a=D(g))}),D=function(t){var e;if(null==l)return-1;var o=(16711680&t)>>16,i=(65280&t)>>8,r=255&t,n=0,a=16777216,d=l.length;for(e=0;e<d;){var c=o-(255&l[e++]),s=i-(255&l[e++]),u=r-(255&l[e]),f=c*c+s*s+u*u,h=e/3;m[h]&&f<a&&(a=f,n=h),e++}return n},U=function(){var t,e,o,i,r,n=d,a=c;for(u=[],t=s,o=e=0;o<a;o++)for(i=0;i<n;i++)r=o*n*4+4*i,u[e++]=t[r],u[e++]=t[r+1],u[e++]=t[r+2]},k=function(){var t,e;r.writeByte(33),r.writeByte(249),r.writeByte(4),null==g?e=t=0:(t=1,e=2),0<=b&&(e=7&b),e<<=2,r.writeByte(0|e|t),N(w),r.writeByte(a),r.writeByte(0)},L=function(){r.writeByte(44),N(0),N(0),N(d),N(c),y?r.writeByte(0):r.writeByte(128|p)},F=function(){N(d),N(c),r.writeByte(240|p),r.writeByte(0),r.writeByte(0)},I=function(){r.writeByte(33),r.writeByte(255),r.writeByte(11),r.writeUTFBytes("NETSCAPE2.0"),r.writeByte(3),r.writeByte(1),N(n),r.writeByte(0)},T=function(){var t,e;for(r.writeBytes(l),t=768-l.length,e=0;e<t;e++)r.writeByte(0)},N=function(t){r.writeByte(255&t),r.writeByte(t>>8&255)},M=function(){new LZWEncoder(d,c,f,h).encode(r)};o.stream=function(){return r},o.setProperties=function(t,e){v=t,y=e};return o};