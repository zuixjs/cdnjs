/**
@license
 * @pnp/sp-clientsvc v1.2.3 - pnp - Provides core functionality to interact with the legacy client.svc SharePoint endpoint
 * MIT (https://github.com/pnp/pnpjs/blob/master/LICENSE)
 * Copyright (c) 2018 Microsoft
 * docs: https://pnp.github.io/pnpjs/
 * source: https:github.com/pnp/pnpjs
 * bugs: https://github.com/pnp/pnpjs/issues
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@pnp/common"),require("tslib"),require("@pnp/odata"),require("@pnp/sp"),require("@pnp/logging")):"function"==typeof define&&define.amd?define(["exports","@pnp/common","tslib","@pnp/odata","@pnp/sp","@pnp/logging"],e):e((t.pnp=t.pnp||{},t.pnp["sp-clientsvc"]={}),t.common,t.tslib_1,t.odata,t.sp,t.logging)}(this,function(t,h,i,p,c,s){"use strict";function e(){return'<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />'}function o(t,e){void 0===t&&(t=null),void 0===e&&(e=null);var n=[];return n.push('<Query Id="$$ID$$" ObjectPathId="$$PATH_ID$$">'),null===t||t.length<1?(n.push('<Query SelectAllProperties="true" >'),n.push("<Properties />")):(n.push('<Query SelectAllProperties="false" >'),n.push("<Properties>"),[].push.apply(n,t.map(function(t){return'<Property Name="'+t+'" SelectAll="true" />'})),n.push("</Properties>")),n.push("</Query >"),null!==e&&(e.length<1?(n.push('<ChildItemQuery SelectAllProperties="true" >'),n.push("<Properties />")):(n.push('<ChildItemQuery SelectAllProperties="false" >'),n.push("<Properties>"),[].push.apply(n,e.map(function(t){return'<Property Name="'+t+'" SelectAll="true" />'})),n.push("</Properties>")),n.push("</ChildItemQuery >")),n.push("</Query >"),n.join("")}function r(t,e,n){var r=[];return r.push('<SetProperty Id="$$ID$$" ObjectPathId="$$PATH_ID$$" Name="'+t+'">'),r.push('<Parameter Type="'+e+'">'+n+"</Parameter>"),r.push("</SetProperty>"),r.join("")}function a(t,e){var n=[];if(n.push('<Method Id="$$ID$$" ObjectPathId="$$PATH_ID$$" Name="'+t+'">'),null!==e){var r=e.toArray();r.length<1?n.push("<Parameters />"):(n.push("<Parameters>"),[].push.apply(n,r.map(function(t){return'<Parameter Type="'+t.type+'">'+t.value+"</Parameter>"})),n.push("</Parameters>"))}return n.push("</Method>"),n.join("")}function u(n){return Object.getOwnPropertyNames(n).map(function(t){var e=n[t];return"boolean"==typeof e?r(t,"Boolean",""+e):"number"==typeof e?r(t,"Number",""+e):"string"==typeof e?r(t,"String",""+e):""},[])}function l(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return new P('<Property Id="$$ID$$" ParentId="$$PARENT_ID$$" Name="'+t+'" />',e)}function d(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return new P('<StaticMethod Id="$$ID$$" Name="'+t+'" TypeId="'+e+'" />',n)}function n(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return new P('<StaticProperty Id="$$ID$$" Name="'+t+'" TypeId="'+e+'" />',n)}var f=function(){function n(t){void 0===t&&(t=[]),this._p=t}return n.build=function(t){void 0===t&&(t=[]);var e=new n;return[].push.apply(e._p,t),e},n.prototype.string=function(t){return this.a("String",t)},n.prototype.number=function(t){return this.a("Number",t.toString())},n.prototype.boolean=function(t){return this.a("Boolean",t.toString())},n.prototype.objectPath=function(t){return this.a("ObjectPath",t.toString())},n.prototype.toArray=function(){return this._p},n.prototype.a=function(t,e){return this._p.push({type:t,value:e}),this},n}();function y(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o=[];if(o.push('<Method Id="$$ID$$" ParentId="$$PARENT_ID$$" Name="'+t+'">'),null!==e){var i=e.toArray();i.length<1?o.push("<Parameters />"):(o.push("<Parameters>"),[].push.apply(o,i.map(function(t){return"ObjectPath"===t.type?'<Parameter ObjectPathId="$$OP_PARAM_ID_'+t.value+'$$" />':'<Parameter Type="'+t.type+'">'+t.value+"</Parameter>"})),o.push("</Parameters>"))}return o.push("</Method>"),new P(o.join(""),n)}function b(t){var e=[],n=[];return t.forEach(function(t){n.push(t.path),e.push.apply(e,t.actions)}),['<Request xmlns="http://schemas.microsoft.com/sharepoint/clientquery/2009" SchemaVersion="15.0.0.0" LibraryVersion="16.0.0.0" ApplicationName="PnPjs">',"<Actions>",e.join(""),"</Actions>","<ObjectPaths>",n.join(""),"</ObjectPaths>","</Request>"].join("")}var P=function(t,e,n,r){void 0===e&&(e=[]),void 0===n&&(n=-1),void 0===r&&(r=[]),this.path=t,this.actions=e,this.id=n,this.replaceAfter=r};function _(t,e){return e.replace(/\$\$ID\$\$/g,t)}function $(t,e){return e.replace(/\$\$PATH_ID\$\$/g,t)}function I(t,e){return e.replace(/\$\$PARENT_ID\$\$/g,t)}function g(t,e,n){void 0===n&&(n=function(t){return t});var r=/\$\$OP_PARAM_ID_(\d+)\$\$/gi.exec(e);if(null!==r)for(var o=1;o<r.length;o++){var i=parseInt(r[o],10),s=new RegExp("\\$\\$OP_PARAM_ID_"+i+"\\$\\$","ig");e=e.replace(s,t[n(i)].toString())}return e}var v=function(){function e(t,e){void 0===t&&(t=[]),void 0===e&&(e={}),this._paths=t,this._relationships=e,this._contextIndex=-1,this._siteIndex=-1,this._webIndex=-1}return e.prototype.add=function(t){return this.dirty(),this._paths.push(t),this.lastIndex},e.prototype.addChildRelationship=function(t,e){h.objectDefinedNotNull(this._relationships["_"+t])?this._relationships["_"+t].push(e):this._relationships["_"+t]=[e]},e.prototype.getChildRelationship=function(t){return h.objectDefinedNotNull(this._relationships["_"+t])?this._relationships["_"+t]:[]},e.prototype.getChildRelationships=function(){return this._relationships},e.prototype.appendAction=function(t,e){return this.dirty(),t.actions.push(e),this},e.prototype.appendActionToLast=function(t){return this.dirty(),this.appendAction(this.last,t)},e.prototype.clone=function(){var t=new e(this.toArray(),h.extend({},this._relationships));return t._contextIndex=this._contextIndex,t._siteIndex=this._siteIndex,t._webIndex=this._webIndex,t},e.prototype.toArray=function(){return this._paths.slice(0)},Object.defineProperty(e.prototype,"last",{get:function(){return this._paths.length<1?null:this._paths[this.lastIndex]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastIndex",{get:function(){return this._paths.length-1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"siteIndex",{get:function(){if(this._siteIndex<0){var t=this.contextIndex;this._siteIndex=this.add(l("Site",'<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />')),this.addChildRelationship(t,this._siteIndex)}return this._siteIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"webIndex",{get:function(){if(this._webIndex<0){var t=this.contextIndex;this._webIndex=this.add(l("Web",'<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />')),this.addChildRelationship(t,this._webIndex)}return this._webIndex},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contextIndex",{get:function(){return this._contextIndex<0&&(this._contextIndex=this.add(n("Current","{3747adcd-a3c3-41b9-bfab-4a64dd2f1e0a}",'<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />'))),this._contextIndex},enumerable:!0,configurable:!0}),e.prototype.toBody=function(){return h.objectDefinedNotNull(this._xml)||(this._xml=b(this.toIndexedTree())),this._xml},e.prototype.toIndexedTree=function(){var o=this,i=-1,s=-1,a=[];return this.toArray().map(function(t,e,n){var r=++i;return a.push(r),t.path=g(a,_(r.toString(),t.path)),0<=s&&(t.path=I(s.toString(),t.path)),t.actions=t.actions.map(function(t){return _((++i).toString(),$(r.toString(),t))}),o.getChildRelationship(e).forEach(function(t){n[t].path=I(r.toString(),n[t].path)}),s=r,t})},e.prototype.dirty=function(){this._xml=null},e}(),m=function(){function t(t){this.op=t}return t.prototype.parse=function(t){var e=this;return t.text().then(function(e){if(!t.ok)throw Error(e);try{return JSON.parse(e)}catch(t){throw Error(e)}}).then(function(t){if(0<t.length&&h.hOP(t[0],"ErrorInfo")&&null!==t[0].ErrorInfo)throw Error(h.jsS(t[0].ErrorInfo));return e.findResult(t)})},t.prototype.findResult=function(t){for(var e=0;e<this.op.actions.length;e++){var n,r=this.op.actions[e];if(/^<ObjectPath/i.test(r))if(!(n=this.getParsedResultById(t,parseInt(h.getAttrValueFromString(r,"Id"),10)))||n&&n.IsNull)return Promise.resolve(null);if(/^<Query/i.test(r))return(n=this.getParsedResultById(t,parseInt(h.getAttrValueFromString(r,"Id"),10)))&&h.hOP(n,"_Child_Items_")?Promise.resolve(n._Child_Items_):Promise.resolve(n)}},t.prototype.getParsedResultById=function(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return t[n+1];return null},t}(),j="_vti_bin/client.svc/ProcessQuery",x=function(r){function t(t,e){void 0===t&&(t=""),void 0===e&&(e=null);var n=r.call(this)||this;return n._objectPaths=e,n._selects=[],"string"==typeof t?(n._parentUrl=t,n._url=h.combine(t.replace(j,""),j),h.objectDefinedNotNull(n._objectPaths)||(n._objectPaths=new v)):(n._parentUrl=t._parentUrl,n._url=h.combine(t._parentUrl,j),h.objectDefinedNotNull(e)||(n._objectPaths=t._objectPaths.clone()),n.configureFrom(t)),n}return i.__extends(t,r),t.prototype.select=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return[].push.apply(this._selects,t),this},t.prototype.inBatch=function(t){if(null!==this.batch)throw Error("This query is already part of a batch.");return this._batch=t,this},t.prototype.toUrlAndQuery=function(){return r.prototype.toUrl.call(this)+"?"+Array.from(this.query).map(function(t){return t[0]+"="+t[1]}).join("&")},t.prototype.getSelects=function(){return h.objectDefinedNotNull(this._selects)?this._selects:[]},t.prototype.getChild=function(t,e,n){var r=this._objectPaths.clone();return r.add(y(e,n,'<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />')),new t(this,r)},t.prototype.getChildProperty=function(t,e){var n=this._objectPaths.clone();return n.add(l(e)),new t(this,n)},t.prototype.send=function(t,e,n){return void 0===e&&(e={}),void 0===n&&(n=null),h.objectDefinedNotNull(n)||(n=new m(t.last)),this.hasBatch?e=h.extend(e,{clientsvc_ObjectPaths:t.clone()}):h.hOP(e,"body")||(e=h.extend(e,{body:t.toBody()})),r.prototype.postCore.call(this,e,n)},t.prototype.sendGet=function(e){var n=this,t=this._objectPaths.clone().appendActionToLast(o(this.getSelects()));return this.send(t).then(function(t){return h.extend(new e(n),t)})},t.prototype.sendGetCollection=function(e){var t=this._objectPaths.clone().appendActionToLast(o([],this.getSelects()));return this.send(t).then(function(t){return t.map(function(t){return h.extend(e(t),t)})})},t.prototype.invokeMethod=function(t,e){void 0===e&&(e=null);for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return this.invokeMethodImpl(t,e,n,o([],null))},t.prototype.invokeNonQuery=function(t,e){void 0===e&&(e=null);for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return this._useCaching=!1,this.invokeMethodImpl(t,e,n,null,!0)},t.prototype.invokeMethodCollection=function(t,e){void 0===e&&(e=null);for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return this.invokeMethodImpl(t,e,n,o([],[]))},t.prototype.invokeUpdate=function(t,e){var n=this,r=this._objectPaths.clone();return u(t).map(function(t){return r.appendActionToLast(t)}),r.appendActionToLast(o([],null)),this.send(r).then(function(t){return h.extend(new e(n),t)})},t.prototype.toRequestContext=function(o,i,s,a){var u=this;return c.toAbsoluteUrl(this.toUrlAndQuery()).then(function(t){h.mergeOptions(i,u._options);var e=new Headers;if(h.mergeHeaders(e,i.headers),h.mergeHeaders(e,{accept:"*/*","content-type":"text/xml"}),i=h.extend(i,{headers:e}),u._useCaching){var n="PnPjs.ProcessQueryClient("+h.getHashCode(u._objectPaths.toBody())+")";h.objectDefinedNotNull(u._cachingOptions)?/\/client\.svc\/ProcessQuery\?$/i.test(u._cachingOptions.key)&&(u._cachingOptions.key=n):u._cachingOptions=new p.CachingOptions(n)}var r=u.hasBatch?u.addBatchDependency():function(){};return{batch:u.batch,batchDependency:r,cachingOptions:u._cachingOptions,clientFactory:function(){return new c.SPHttpClient},isBatched:u.hasBatch,isCached:u._useCaching,options:i,parser:s,pipeline:a,requestAbsoluteUrl:t,requestId:h.getGUID(),verb:o}})},t.prototype.addBatchDependency=function(){return null!==this._batch?this._batch.addDependency():function(){return null}},Object.defineProperty(t.prototype,"hasBatch",{get:function(){return h.objectDefinedNotNull(this._batch)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"batch",{get:function(){return this.hasBatch?this._batch:null},enumerable:!0,configurable:!0}),t.prototype.invokeMethodImpl=function(t,e,n,r,o){void 0===o&&(o=!1);var i=this._objectPaths.clone();return o?i.appendActionToLast(a(t,e)):i.add(y.apply(void 0,[t,e].concat(['<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />'].concat(n,[r])))),this.send(i)},t}(p.Queryable),O=function(r){function t(t,e){var n=r.call(this,e)||this;return n.parentUrl=t,n}return i.__extends(t,r),t.prototype.executeImpl=function(){if(this.requests.length<1)return s.Logger.write("Resolving empty batch.",1),Promise.resolve();var t=new A(this.parentUrl,this.batchId);return t.appendRequests(this.requests),t.execute()},t}(p.ODataBatch),A=function(o){function t(t,e){var n=o.call(this,t)||this;n.batchId=e,n._requests=[],n._builderIndex=1;var r=d("GetTaxonomySession","{981cbc68-9edc-4f8d-872f-71146fcbb84f}");return r.path=_("0",r.path),r.actions.push(_("1",$("0",'<ObjectPath Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />'))),n._objectPaths.add(r),n}return i.__extends(t,o),t.prototype.appendRequests=function(t){var c=this;t.forEach(function(t){var s=t.options.clientsvc_ObjectPaths,e=s.toArray();if(!(e.length<0)){var a=function(t){return t};/GetTaxonomySession/i.test(e[0].path)&&((e=e.slice(1))[0].path=I("0",e[0].path),a=function(t){return t-1});var u=-1,h=[];e.map(function(t,e,n){var r=++c._builderIndex;h.push(r);var o=g(h,_(r.toString(),t.path),a);0<=u&&(o=I(u.toString(),o));var i=t.actions.map(function(t){return _((++c._builderIndex).toString(),$(r.toString(),t))});return s.getChildRelationship(e+1).map(function(t){return t-1}).forEach(function(t){n[t].path=I(r.toString(),n[t].path)}),u=r,new P(o,i)}).forEach(function(t){return c._objectPaths.add(t)});var n=c._objectPaths.toArray(),r=new m(n[n.length-1]);t.parser instanceof p.CachingParserWrapper?t.parser=new w(r,t.parser):t.parser=r,c._requests.push(t),delete t.options.clientsvc_ObjectPaths}})},t.prototype.execute=function(){var r=this;s.Logger.write("["+this.batchId+"] ("+(new Date).getTime()+") Executing batch with "+this._requests.length+" requests.",1);var t={body:b(this._objectPaths.toArray())};return s.Logger.write("["+this.batchId+"] ("+(new Date).getTime()+") Sending batch request.",1),o.prototype.postCore.call(this,t,new D).then(function(n){return s.Logger.write("["+r.batchId+"] ("+(new Date).getTime()+") Resolving batched requests.",1),r._requests.reduce(function(t,e){return s.Logger.write("["+e.id+"] ("+(new Date).getTime()+") Resolving request in batch "+r.batchId+".",1),t.then(function(t){return e.parser.findResult(n).then(e.resolve).catch(e.reject)})},Promise.resolve())})},t}(x),D=function(t){function e(){return t.call(this,null)||this}return i.__extends(e,t),e.prototype.findResult=function(t){return t},e}(m),w=function(n){function t(t,e){return n.call(this,t,e.cacheOptions)||this}return i.__extends(t,n),t.prototype.findResult=function(t){var e=this;return this.parser.findResult(t).then(function(t){return e.cacheData(t)})},t}(p.CachingParserWrapper);t.ObjectPathBatch=O,t.ClientSvcQueryable=x,t.ObjectPath=P,t.opSetId=_,t.opSetPathId=$,t.opSetParentId=I,t.opSetPathParamId=g,t.ObjectPathQueue=v,t.objectPath=e,t.identityQuery=function(){return'<ObjectIdentityQuery Id="$$ID$$" ObjectPathId="$$PATH_ID$$" />'},t.opQuery=o,t.setProperty=r,t.methodAction=a,t.objectProperties=u,t.property=l,t.staticMethod=d,t.staticProperty=n,t.objConstructor=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return new P('<Constructor Id="$$ID$$" TypeId="'+t+'" />',e)},t.MethodParams=f,t.method=y,t.ProcessQueryParser=m,t.writeObjectPathBody=b,Object.defineProperty(t,"__esModule",{value:!0})});