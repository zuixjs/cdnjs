L.OSM=L.FeatureGroup.extend({options:{async:!0,forceAll:!1},initialize:function(t,e){L.Util.setOptions(this,e),this._url=t,this._layers={},t&&this.addXML(t,e,this.options.async)},loadXML:function(t,e,a,n){void 0===n&&(n=this.options.async),void 0===a&&(a=this.options);var r=new window.XMLHttpRequest;r.open("GET",t,n),r.overrideMimeType("text/xml"),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&e(r.responseXML,a)},r.send(null)},addXML:function(t,e,a){var n=this;this.loadXML(t,function(t,e){n._addXML(t,e)},e,a)},_addXML:function(t,e){var a=this.parseOSM(t,e);a&&(this.addLayer(a),this.fire("loaded"))},parseOSM:function(t,e){var a,n,r,i=[],s={},o={},l=!1;for(n=t.getElementsByTagName("node"),a=0;a<n.length;a++){var g=this.parse_node(n[a],t,e);if(void 0!==g&&(s[g.osmid]=g,this.options.forceAll||g.tags.length)){var u=this.named_node(g,e);r||(r=u.getLatLng()),this.parse_name(u,g,"Node")&&(l=!0),i.push(u)}}for(n=t.getElementsByTagName("way"),a=0;a<n.length&&!(a>10);a++){var h=this.parse_way(n[a],s,e);h&&(r||(r=h.getLatLngs()[0]),this.parse_name(h,h,"Way")&&(l=!0),i.push(h),o[h.osmid]=h)}for(n=t.getElementsByTagName("relation"),a=0;a<n.length&&!(a>10);a++){var d=this.parse_relation(n[a],o,e);d&&(r||(r=d.getLatLngs()[0]),this.parse_name(d,d,"Relation")&&(l=!0),i.push(d))}if(i.length){var p=i[0];return i.length>1&&(p=new L.FeatureGroup(i)),l||this.parse_name(t,p),p.focusPoint=r,p}},parse_name:function(t,e,a){if(this.options.forceAll||e.tags&&e.tags.length){var n,r="<table>";for(n=0;n<e.tags.length;n++){var i=e.tags[n];r+="<tr><td>"+i.k+"</td><td>=</td><td>"+i.v+"</td></tr>"}return r+="</table>",r="<h2>"+a+" "+e.osmid+"</h2>"+r,t&&t.bindPopup(r),r}},parse_tags:function(t){for(var e=[],a=t.getElementsByTagName("tag"),n=0;n<a.length;n++)e.push({k:a[n].getAttribute("k"),v:a[n].getAttribute("v")});return e},parse_node:function(t){var e={osmid:t.getAttribute("id"),lat:t.getAttribute("lat"),lon:t.getAttribute("lon")};return e.ll=new L.LatLng(e.lat,e.lon),e.tags=this.parse_tags(t),e},parse_way:function(t,e,a){var n=t.getElementsByTagName("nd");if(n.length){for(var r=[],i=0;i<n.length;i++){var s=e[n[i].getAttribute("ref")];if(!s)return;r.push(s.ll)}var o=new L.Polyline(r,a);return o.tags=this.parse_tags(t),o.osmid=t.getAttribute("id"),o}},parse_relation:function(t,e,a){var n=t.getElementsByTagName("member");if(n.length){var r,i,s=[],o=this.parse_tags(t);for(i=0;i<o.length;i++)"type"===o[i].k&&(r=o[i].v);if("multipolygon"===r||"boundary"===r||"waterway"===r){for(i=0;i<n.length;i++){var l=n[i].getAttribute("type"),g=n[i].getAttribute("ref");if("way"===l){var u=e[g];if(!u)return;s.push(u)}}if(s.length){var h=new L.MultiPolyline(s,a);return h.tags=this.parse_tags(t),h.osmid=t.getAttribute("id"),h}}}},named_node:function(t,e){return new L.Marker(new L.LatLng(t.lat,t.lon),e)}});