"use strict";var Dispatcher=require("flux").Dispatcher;var EventEmitter=require("eventemitter3");var Symbol=require("es-symbol");var assign=require("object-assign");var now=Date.now();var VariableSymbol=function(a){return Symbol(""+now+""+a)};var ACTION_HANDLER=Symbol("action creator handler");var ACTION_KEY=Symbol("holds the actions uid symbol for listening");var ACTION_UID=Symbol("the actions uid name");var EE=Symbol("event emitter instance");var INIT_SNAPSHOT=Symbol("init snapshot storage");var LAST_SNAPSHOT=Symbol("last snapshot storage");var LIFECYCLE=Symbol("store lifecycle listeners");var LISTENERS=Symbol("stores action listeners storage");var STATE_CONTAINER=VariableSymbol("the state container");var formatAsConstant=function(a){return a.replace(/[a-z]([A-Z])/g,function(b){return""+b[0]+"_"+b[1].toLowerCase()}).toUpperCase()};function NoopClass(){}var builtIns=Object.getOwnPropertyNames(NoopClass);var builtInProto=Object.getOwnPropertyNames(NoopClass.prototype);var getInternalMethods=function(b,a){return Object.getOwnPropertyNames(b).reduce(function(d,c){if(a.indexOf(c)!==-1){return d}d[c]=b[c];return d},{})};var AltStore=(function(){function e(g,h){var f=this;babelHelpers.classCallCheck(this,e);this[EE]=new EventEmitter();this[LIFECYCLE]={};this[STATE_CONTAINER]=h;assign(this[LIFECYCLE],h[LIFECYCLE]);this.dispatchToken=g.register(function(j){if(h[LISTENERS][j.action]){var i=h[LISTENERS][j.action](j.data);i!==false&&f.emitChange()}});if(this[LIFECYCLE].init){this[LIFECYCLE].init()}}babelHelpers.prototypeProperties(e,null,{emitChange:{value:function d(){this[EE].emit("change",this[STATE_CONTAINER])},writable:true,configurable:true},listen:{value:function b(f){this[EE].on("change",f)},writable:true,configurable:true},unlisten:{value:function c(f){this[EE].removeListener("change",f)},writable:true,configurable:true},getState:{value:function a(){return assign({},this[STATE_CONTAINER])},writable:true,configurable:true}});return e})();var ActionCreator=(function(){function b(e,c,d,f){babelHelpers.classCallCheck(this,b);this[ACTION_UID]=c;this[ACTION_HANDLER]=d.bind(this);this.actions=f;this.alt=e}babelHelpers.prototypeProperties(b,null,{dispatch:{value:function a(c){this.alt.dispatch(this[ACTION_UID],c)},writable:true,configurable:true}});return b})();var StoreMixin={on:function on(b,a){this[LIFECYCLE][b]=a.bind(this)},bindAction:function bindAction(b,a){if(!b){throw new ReferenceError("Invalid action reference passed in")}if(typeof a!=="function"){throw new TypeError("bindAction expects a function")}if(a.length>1){throw new TypeError("Action handler in store "+this._storeName+" for "+(""+(b[ACTION_KEY]||b)+" was defined with 2 parameters. ")+"Only a single parameter is passed through the dispatcher, did you mean to pass in an Object instead?")}if(b[ACTION_KEY]){this[LISTENERS][b[ACTION_KEY]]=a.bind(this)}else{this[LISTENERS][b]=a.bind(this)}},bindActions:function bindActions(b){var a=this;Object.keys(b).forEach(function(e){var d=b[e];var g=/./;var f=e.replace(g,function(h){return"on"+h[0].toUpperCase()});var c=null;if(a[e]&&a[f]){throw new ReferenceError("You have multiple action handlers bound to an action: "+(""+e+" and "+f))}else{if(a[e]){c=a[e]}else{if(a[f]){c=a[f]}}}if(c){a.bindAction(d,c)}})},waitFor:function waitFor(a){if(!a){throw new ReferenceError("Dispatch tokens not provided")}a=Array.isArray(a)?a:[a];this.dispatcher.waitFor(a)}};var setAppState=function(a,c,b){var d=JSON.parse(c);Object.keys(d).forEach(function(e){assign(a.stores[e][STATE_CONTAINER],d[e]);b(a.stores[e])})};var snapshot=function(a){return JSON.stringify(Object.keys(a.stores).reduce(function(c,b){if(a.stores[b][LIFECYCLE].snapshot){a.stores[b][LIFECYCLE].snapshot()}c[b]=a.stores[b].getState();return c},{}))};var saveInitialSnapshot=function(a,c){var d=a.stores[c][STATE_CONTAINER];var b=JSON.parse(a[INIT_SNAPSHOT]);b[c]=d;a[INIT_SNAPSHOT]=JSON.stringify(b)};var filterSnapshotOfStores=function(c,b){var a=JSON.parse(c);var d=b.reduce(function(f,e){if(!a[e]){throw new ReferenceError(""+e+" is not a valid store")}f[e]=a[e];return f},{});return JSON.stringify(d)};var Alt=(function(){function h(){babelHelpers.classCallCheck(this,h);this.dispatcher=new Dispatcher();this.actions={};this.stores={};this[LAST_SNAPSHOT]=null;this[INIT_SNAPSHOT]="{}"}babelHelpers.prototypeProperties(h,null,{dispatch:{value:function i(o,n){this.dispatcher.dispatch({action:o,data:n})},writable:true,configurable:true},createStore:{value:function j(q,p){var o=this;var r=p||q.displayName||q.name;var s=(function(t){function u(){babelHelpers.classCallCheck(this,u);this[LIFECYCLE]={};this[LISTENERS]={};babelHelpers.get(Object.getPrototypeOf(u.prototype),"constructor",this).call(this)}babelHelpers.inherits(u,t);return u})(q);assign(s.prototype,StoreMixin,{_storeName:r,alt:this,dispatcher:this.dispatcher,getInstance:function(){return o.stores[r]}});var n=new s();if(this.stores[r]){throw new ReferenceError("A store named "+r+" already exists, double check your store names or pass in\nyour own custom identifier for each store")}this.stores[r]=assign(new AltStore(this.dispatcher,n),getInternalMethods(q,builtIns));saveInitialSnapshot(this,r);return this.stores[r]},writable:true,configurable:true},createActions:{value:function d(s){var o=this;var q=arguments[1]===undefined?{}:arguments[1];var r=assign({},getInternalMethods(s.prototype,builtInProto));var p=s.displayName||s.name;var n=(function(v){function t(){babelHelpers.classCallCheck(this,t);babelHelpers.get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this)}babelHelpers.inherits(t,v);babelHelpers.prototypeProperties(t,null,{generateActions:{value:function u(){for(var w=arguments.length,y=Array(w),x=0;x<w;x++){y[x]=arguments[x]}y.forEach(function(z){r[z]=function(B){for(var A=arguments.length,C=Array(A>1?A-1:0),D=1;D<A;D++){C[D-1]=arguments[D]}this.dispatch(C.length?[B].concat(C):B)}})},writable:true,configurable:true}});return t})(s);new n();return Object.keys(r).reduce(function(x,v){var u=formatAsConstant(v);var t=Symbol(""+p+"#"+v);var w=new ActionCreator(o,t,r[v],x);x[v]=w[ACTION_HANDLER];x[v].defer=function(){for(var y=arguments.length,z=Array(y),A=0;A<y;A++){z[A]=arguments[A]}setTimeout(function(){return w[ACTION_HANDLER].apply(null,z)})};x[v][ACTION_KEY]=t;x[u]=t;return x},q)},writable:true,configurable:true},takeSnapshot:{value:function k(){var n=snapshot(this);this[LAST_SNAPSHOT]=n;return n},writable:true,configurable:true},rollback:{value:function l(){setAppState(this,this[LAST_SNAPSHOT],function(n){if(n[LIFECYCLE].rollback){n[LIFECYCLE].rollback()}})},writable:true,configurable:true},recycle:{value:function e(){for(var o=arguments.length,n=Array(o),q=0;q<o;q++){n[q]=arguments[q]}var p=n.length?filterSnapshotOfStores(this[INIT_SNAPSHOT],n):this[INIT_SNAPSHOT];setAppState(this,p,function(r){if(r[LIFECYCLE].init){r[LIFECYCLE].init()}})},writable:true,configurable:true},flush:{value:function m(){var n=snapshot(this);this.recycle();return n},writable:true,configurable:true},bootstrap:{value:function f(n){setAppState(this,n,function(o){if(o[LIFECYCLE].bootstrap){o[LIFECYCLE].bootstrap()}})},writable:true,configurable:true},addActions:{value:function c(n,o){this.actions[n]=this.createActions(o)},writable:true,configurable:true},addStore:{value:function b(o,n){this.createStore(n,o)},writable:true,configurable:true},getActions:{value:function a(n){return this.actions[n]},writable:true,configurable:true},getStore:{value:function g(n){return this.stores[n]},writable:true,configurable:true}});return h})();module.exports=Alt;