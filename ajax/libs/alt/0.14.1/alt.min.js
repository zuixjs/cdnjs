"use strict";var _interopRequire=function(a){return a&&a.__esModule?a["default"]:a};var _get=function get(b,e,d){var f=Object.getOwnPropertyDescriptor(b,e);if(f===undefined){var c=Object.getPrototypeOf(b);if(c===null){return undefined}else{return get(c,e,d)}}else{if("value" in f&&f.writable){return f.value}else{var a=f.get;if(a===undefined){return undefined}return a.call(d)}}};var _inherits=function(b,a){if(typeof a!=="function"&&a!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof a)}b.prototype=Object.create(a&&a.prototype,{constructor:{value:b,enumerable:false,writable:true,configurable:true}});if(a){b.__proto__=a}};var _prototypeProperties=function(c,b,a){if(b){Object.defineProperties(c,b)}if(a){Object.defineProperties(c.prototype,a)}};var _classCallCheck=function(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}};var Dispatcher=require("flux").Dispatcher;var EventEmitter=_interopRequire(require("eventemitter3"));var Symbol=_interopRequire(require("es-symbol"));var assign=_interopRequire(require("object-assign"));var now=Date.now();var VariableSymbol=function(a){return Symbol(""+now+""+a)};var ACTION_HANDLER=Symbol("action creator handler");var ACTION_KEY=Symbol("holds the actions uid symbol for listening");var ACTION_UID=Symbol("the actions uid name");var EE=Symbol("event emitter instance");var INIT_SNAPSHOT=Symbol("init snapshot storage");var LAST_SNAPSHOT=Symbol("last snapshot storage");var LIFECYCLE=Symbol("store lifecycle listeners");var LISTENERS=Symbol("stores action listeners storage");var STATE_CONTAINER=VariableSymbol("the state container");var formatAsConstant=function(a){return a.replace(/[a-z]([A-Z])/g,function(b){return""+b[0]+"_"+b[1].toLowerCase()}).toUpperCase()};function NoopClass(){}var builtIns=Object.getOwnPropertyNames(NoopClass);var builtInProto=Object.getOwnPropertyNames(NoopClass.prototype);var getInternalMethods=function(b,a){return Object.getOwnPropertyNames(b).reduce(function(d,c){if(a.indexOf(c)!==-1){return d}d[c]=b[c];return d},{})};var AltStore=(function(){function f(h,i){var g=this;_classCallCheck(this,f);this[EE]=new EventEmitter();this[LIFECYCLE]={};this[STATE_CONTAINER]=i;assign(this[LIFECYCLE],i[LIFECYCLE]);this.dispatchToken=h.register(function(k){if(i[LISTENERS][k.action]){var j=i[LISTENERS][k.action](k.data);j!==false&&g.emitChange()}});if(this[LIFECYCLE].init){this[LIFECYCLE].init()}}_prototypeProperties(f,null,{getEventEmitter:{value:function d(){return this[EE]},writable:true,configurable:true},emitChange:{value:function e(){this[EE].emit("change",this[STATE_CONTAINER])},writable:true,configurable:true},listen:{value:function b(g){this[EE].on("change",g)},writable:true,configurable:true},unlisten:{value:function c(g){this[EE].removeListener("change",g)},writable:true,configurable:true},getState:{value:function a(){return assign({},this[STATE_CONTAINER])},writable:true,configurable:true}});return f})();var ActionCreator=(function(){function b(e,c,d,f){_classCallCheck(this,b);this[ACTION_UID]=c;this[ACTION_HANDLER]=d.bind(this);this.actions=f;this.alt=e}_prototypeProperties(b,null,{dispatch:{value:function a(c){this.alt.dispatch(this[ACTION_UID],c)},writable:true,configurable:true}});return b})();var StoreMixin={on:function on(b,a){this[LIFECYCLE][b]=a.bind(this)},bindAction:function bindAction(b,a){if(!b){throw new ReferenceError("Invalid action reference passed in")}if(typeof a!=="function"){throw new TypeError("bindAction expects a function")}if(a.length>1){throw new TypeError("Action handler in store "+this._storeName+" for "+(""+(b[ACTION_KEY]||b).toString()+" was defined with 2 ")+"parameters. Only a single parameter is passed through the dispatcher, did you mean to pass in an Object instead?")}if(b[ACTION_KEY]){this[LISTENERS][b[ACTION_KEY]]=a.bind(this)}else{this[LISTENERS][b]=a.bind(this)}},bindActions:function bindActions(b){var a=this;Object.keys(b).forEach(function(e){var d=b[e];var g=/./;var f=e.replace(g,function(h){return"on"+h[0].toUpperCase()});var c=null;if(a[e]&&a[f]){throw new ReferenceError("You have multiple action handlers bound to an action: "+(""+e+" and "+f))}else{if(a[e]){c=a[e]}else{if(a[f]){c=a[f]}}}if(c){a.bindAction(d,c)}})},bindListeners:function bindListeners(b){var a=this;Object.keys(b).forEach(function(c){var e=b[c];var d=a[c];if(!d){throw new ReferenceError(""+c+" defined but does not exist in "+a._storeName)}if(Array.isArray(e)){e.forEach(function(f){return a.bindAction(f,d)})}else{a.bindAction(e,d)}})},waitFor:function waitFor(a){if(!a){throw new ReferenceError("Dispatch tokens not provided")}if(arguments.length===1){a=Array.isArray(a)?a:[a]}else{a=Array.prototype.slice.call(arguments)}var b=a.map(function(c){return c.dispatchToken||c});this.dispatcher.waitFor(b)}};var setAppState=function(a,c,b){var d=JSON.parse(c);Object.keys(d).forEach(function(e){assign(a.stores[e][STATE_CONTAINER],d[e]);b(a.stores[e])})};var snapshot=function(a){return JSON.stringify(Object.keys(a.stores).reduce(function(c,b){if(a.stores[b][LIFECYCLE].snapshot){a.stores[b][LIFECYCLE].snapshot()}c[b]=a.stores[b].getState();return c},{}))};var saveInitialSnapshot=function(a,c){var d=a.stores[c][STATE_CONTAINER];var b=JSON.parse(a[INIT_SNAPSHOT]);b[c]=d;a[INIT_SNAPSHOT]=JSON.stringify(b)};var filterSnapshotOfStores=function(c,b){var a=JSON.parse(c);var d=b.reduce(function(f,e){if(!a[e]){throw new ReferenceError(""+e+" is not a valid store")}f[e]=a[e];return f},{});return JSON.stringify(d)};var Alt=(function(){function h(){_classCallCheck(this,h);this.dispatcher=new Dispatcher();this.actions={};this.stores={};this[LAST_SNAPSHOT]=null;this[INIT_SNAPSHOT]="{}"}_prototypeProperties(h,null,{dispatch:{value:function i(p,o){this.dispatcher.dispatch({action:p,data:o})},writable:true,configurable:true},createStore:{value:function j(r,q){var o=arguments[2]===undefined?true:arguments[2];var w=undefined;var y=q||r.name||r.displayName||"";if(o&&(this.stores[y]||!y)){if(typeof console!=="undefined"){if(this.stores[y]){console.warn(new ReferenceError("A store named "+y+" already exists, double check your store names or pass in your own custom identifier for each store"))}else{console.warn(new ReferenceError("Store name was not specified"))}}var t=0;while(this.stores[y]){y=y+String(++t)}}var u=(function(z){function A(B){_classCallCheck(this,A);this[LIFECYCLE]={};this[LISTENERS]={};_get(Object.getPrototypeOf(A.prototype),"constructor",this).call(this,B)}_inherits(A,z);return A})(r);assign(u.prototype,StoreMixin,{_storeName:y,alt:this,dispatcher:this.dispatcher,getInstance:function p(){return w},emitChange:function v(){this.getInstance().emitChange()},setState:function s(){var z=arguments[0]===undefined?{}:arguments[0];assign(this,z);this.emitChange();return false}});var x=new u(this);w=assign(new AltStore(this.dispatcher,x),getInternalMethods(r,builtIns));if(o){this.stores[y]=w;saveInitialSnapshot(this,y)}return w},writable:true,configurable:true},generateActions:{value:function k(){for(var o=arguments.length,q=Array(o),p=0;p<o;p++){q[p]=arguments[p]}return this.createActions(function(){var r;(r=this).generateActions.apply(r,q)})},writable:true,configurable:true},createActions:{value:function d(t){var p=this;var r=arguments[1]===undefined?{}:arguments[1];var s=assign({},getInternalMethods(t.prototype,builtInProto));var q=t.name||t.displayName||"";var o=(function(w){function u(x){_classCallCheck(this,u);_get(Object.getPrototypeOf(u.prototype),"constructor",this).call(this,x)}_inherits(u,w);_prototypeProperties(u,null,{generateActions:{value:function v(){for(var x=arguments.length,z=Array(x),y=0;y<x;y++){z[y]=arguments[y]}z.forEach(function(A){s[A]=function(C){for(var B=arguments.length,D=Array(B>1?B-1:0),E=1;E<B;E++){D[E-1]=arguments[E]}this.dispatch(D.length?[C].concat(D):C)}})},writable:true,configurable:true}});return u})(t);new o(this);return Object.keys(s).reduce(function(y,w){var v=formatAsConstant(w);var u=Symbol(""+q+"#"+w);var x=new ActionCreator(p,u,s[w],y);y[w]=x[ACTION_HANDLER];y[w].defer=function(){for(var z=arguments.length,A=Array(z),B=0;B<z;B++){A[B]=arguments[B]}setTimeout(function(){return x[ACTION_HANDLER].apply(null,A)})};y[w][ACTION_KEY]=u;y[v]=u;return y},r)},writable:true,configurable:true},takeSnapshot:{value:function l(){var o=snapshot(this);this[LAST_SNAPSHOT]=o;return o},writable:true,configurable:true},rollback:{value:function m(){setAppState(this,this[LAST_SNAPSHOT],function(o){if(o[LIFECYCLE].rollback){o[LIFECYCLE].rollback()}})},writable:true,configurable:true},recycle:{value:function e(){for(var p=arguments.length,o=Array(p),r=0;r<p;r++){o[r]=arguments[r]}var q=o.length?filterSnapshotOfStores(this[INIT_SNAPSHOT],o):this[INIT_SNAPSHOT];setAppState(this,q,function(s){if(s[LIFECYCLE].init){s[LIFECYCLE].init()}})},writable:true,configurable:true},flush:{value:function n(){var o=snapshot(this);this.recycle();return o},writable:true,configurable:true},bootstrap:{value:function f(o){setAppState(this,o,function(p){if(p[LIFECYCLE].bootstrap){p[LIFECYCLE].bootstrap()}})},writable:true,configurable:true},addActions:{value:function c(o,p){this.actions[o]=this.createActions(p)},writable:true,configurable:true},addStore:{value:function b(p,o,q){this.createStore(o,p,q)},writable:true,configurable:true},getActions:{value:function a(o){return this.actions[o]},writable:true,configurable:true},getStore:{value:function g(o){return this.stores[o]},writable:true,configurable:true}});return h})();module.exports=Alt;