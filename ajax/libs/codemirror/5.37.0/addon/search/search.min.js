!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(d){"use strict";function o(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function y(e){return e.state.search||(e.state.search=new o)}function i(e){return"string"==typeof e&&e==e.toLowerCase()}function p(e,o,n){return e.getSearchCursor(o,n,{caseFold:i(o),multiline:!0})}function m(e,o,n,r,t){e.openDialog?e.openDialog(o,t,{value:r,selectValueOnOpen:!0}):t(prompt(n,r))}function r(e){return e.replace(/\\(.)/g,function(e,o){return"n"==o?"\n":"r"==o?"\r":o})}function a(e){var o=e.match(/^\/(.*)\/([a-z]*)$/);if(o)try{e=new RegExp(o[1],-1==o[2].indexOf("i")?"":"i")}catch(e){}else e=r(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}var g='<span class="CodeMirror-search-label">Search:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>';function h(e,o,n){var r,t;o.queryText=n,o.query=a(n),e.removeOverlay(o.overlay,i(o.query)),o.overlay=(r=o.query,t=i(o.query),"string"==typeof r?r=new RegExp(r.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"gi":"g"):r.global||(r=new RegExp(r.source,r.ignoreCase?"gi":"g")),{token:function(e){r.lastIndex=e.pos;var o=r.exec(e.string);if(o&&o.index==e.pos)return e.pos+=o[0].length||1,"searching";o?e.pos=o.index:e.skipToEnd()}}),e.addOverlay(o.overlay),e.showMatchesOnScrollbar&&(o.annotate&&(o.annotate.clear(),o.annotate=null),o.annotate=e.showMatchesOnScrollbar(o.query,i(o.query)))}function n(i,o,e,n){var r=y(i);if(r.query)return v(i,o);var t,a,s,c,l,u=i.getSelection()||r.lastQuery;if(u instanceof RegExp&&"x^"==u.source&&(u=null),e&&i.openDialog){var f=null,p=function(e,o){d.e_stop(o),e&&(e!=r.queryText&&(h(i,r,e),r.posFrom=r.posTo=i.getCursor()),f&&(f.style.opacity=1),v(i,o.shiftKey,function(e,o){var n;o.line<3&&document.querySelector&&(n=i.display.wrapper.querySelector(".CodeMirror-dialog"))&&n.getBoundingClientRect().bottom-4>i.cursorCoords(o,"window").top&&((f=n).style.opacity=.4)}))};a=g,s=u,c=p,l=function(e,o){var n=d.keyName(e),r=i.getOption("extraKeys"),t=r&&r[n]||d.keyMap[i.getOption("keyMap")][n];"findNext"==t||"findPrev"==t||"findPersistentNext"==t||"findPersistentPrev"==t?(d.e_stop(e),h(i,y(i),o),i.execCommand(t)):"find"!=t&&"findPersistent"!=t||(d.e_stop(e),p(o,e))},(t=i).openDialog(a,c,{value:s,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){x(t)},onKeyDown:l}),n&&u&&(h(i,r,u),v(i,o))}else m(i,g,"Search for:",u,function(e){e&&!r.query&&i.operation(function(){h(i,r,e),r.posFrom=r.posTo=i.getCursor(),v(i,o)})})}function v(n,r,t){n.operation(function(){var e=y(n),o=p(n,e.query,r?e.posFrom:e.posTo);(o.find(r)||(o=p(n,e.query,r?d.Pos(n.lastLine()):d.Pos(n.firstLine(),0))).find(r))&&(n.setSelection(o.from(),o.to()),n.scrollIntoView({from:o.from(),to:o.to()},20),e.posFrom=o.from(),e.posTo=o.to(),t&&t(o.from(),o.to()))})}function x(o){o.operation(function(){var e=y(o);e.lastQuery=e.query,e.query&&(e.query=e.queryText=null,o.removeOverlay(e.overlay),e.annotate&&(e.annotate.clear(),e.annotate=null))})}var t=' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',s='<span class="CodeMirror-search-label">With:</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',C='<span class="CodeMirror-search-label">Replace?</span> <button>Yes</button> <button>No</button> <button>All</button> <button>Stop</button>';function q(o,r,t){o.operation(function(){for(var e=p(o,r);e.findNext();)if("string"!=typeof r){var n=o.getRange(e.from(),e.to()).match(r);e.replace(t.replace(/\$(\d)/g,function(e,o){return n[o]}))}else e.replace(t)})}function c(f,e){if(!f.getOption("readOnly")){var o=f.getSelection()||y(f).lastQuery,n='<span class="CodeMirror-search-label">'+(e?"Replace all:":"Replace:")+"</span>";m(f,n+t,n,o,function(u){u&&(u=a(u),m(f,s,"Replace with:","",function(a){if(a=r(a),e)q(f,u,a);else{x(f);var s=p(f,u,f.getCursor("from")),c=function(){var e,o,n,r,t,i=s.from();!(e=s.findNext())&&(s=p(f,u),!(e=s.findNext())||i&&s.from().line==i.line&&s.from().ch==i.ch)||(f.setSelection(s.from(),s.to()),f.scrollIntoView({from:s.from(),to:s.to()}),n=C,r="Replace?",t=[function(){l(e)},c,function(){q(f,u,a)}],(o=f).openConfirm?o.openConfirm(n,t):confirm(r)&&t[0]())},l=function(n){s.replace("string"==typeof u?a:a.replace(/\$(\d)/g,function(e,o){return n[o]})),c()};c()}}))})}}d.commands.find=function(e){x(e),n(e)},d.commands.findPersistent=function(e){x(e),n(e,!1,!0)},d.commands.findPersistentNext=function(e){n(e,!1,!0,!0)},d.commands.findPersistentPrev=function(e){n(e,!0,!0,!0)},d.commands.findNext=n,d.commands.findPrev=function(e){n(e,!0)},d.commands.clearSearch=x,d.commands.replace=c,d.commands.replaceAll=function(e){c(e,!0)}});