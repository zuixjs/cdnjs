/*!
 * vuefire v2.0.0-alpha.6
 * (c) 2017 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Vuefire={})}(this,function(e){"use strict";function t(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function n(e,t,r,i){void 0===r&&(r=""),void 0===i&&(i=[{},{}]),t=t||{};var o=Object.getOwnPropertyDescriptor(e,"id");return o&&!o.enumerable&&Object.defineProperty(i[0],"id",o),Object.keys(e).reduce(function(i,o){var s=e[o];s&&"function"==typeof s.isEqual?(i[0][o]=t[o]||s.path,i[1][r+o]=s):Array.isArray(s)?(i[0][o]=Array(s.length).fill(null),n(s,t[o],r+o+".",[i[0][o],i[1]])):(u=s)&&"object"==typeof u?(i[0][o]={},n(s,t[o],r+o+".",[i[0][o],i[1]])):i[0][o]=s;var u;return i},i)}function r(e,t,n){var r=(""+t).split("."),i=r.pop(),o=r.reduce(function(e,t){return e[t]},e);isFinite(i)?o.splice(i,1,n):o[i]=n}function i(e){for(var t in e)e[t].unsub()}function o(e,n){var o=e.subs,u=e.refs,c=e.target,f=e.path,a=(e.data,e.depth),d=e.resolve,l=Object.keys(u);if(Object.keys(o).filter(function(e){return l.indexOf(e)<0}).forEach(function(e){o[e].unsub(),delete o[e]}),!l.length||++a>n.maxRefDepth)return d(f);var p=0,h=l.length,v=Object.create(null);l.forEach(function(e){var l=o[e],b=u[e],y=f+"."+e;if(v[y]=!0,l){if(l.path===b.path)return;l.unsub()}o[e]={unsub:function(e,n){var o=e.ref,u=e.target,c=e.path,f=e.depth,a=e.resolve,d=Object.create(null),l=o.onSnapshot(function(e){e.exists?s({snapshot:t(e),target:u,path:c,subs:d,depth:f,resolve:a},n):(r(u,c,null),a(c))});return function(){l(),i(d)}}({ref:b,target:c,path:y,depth:a,resolve:function(e){e in v&&++p>=h&&d(f)}.bind(null,y)},n),path:b.path}})}function s(e,t){var i=e.snapshot,s=e.target,u=e.path,c=e.subs,f=e.depth;void 0===f&&(f=0);var a,d,l=e.resolve,p=n(i,(a=s,d=u,d.split(".").reduce(function(e,t){return e[t]},a))),h=p[0],v=p[1];r(s,u,h),o({data:h,subs:c,refs:v,target:s,path:u,depth:f,resolve:l},t)}function u(e,r){var u=e.vm,c=e.key,f=e.ref;return void 0===r&&(r={maxRefDepth:2}),new Promise(function(e,a){var d;d=f.where?function(e,r){var s,u=e.vm,c=e.key,f=e.collection,a=e.resolve,d=e.reject,l=u[c]=[],p=a,h=[],v={added:function(e){var i=e.newIndex,s=e.doc;h.splice(i,0,Object.create(null));var u=h[i],c=n(t(s)),f=c[0],d=c[1];l.splice(i,0,f),o({data:f,refs:d,subs:u,target:l,path:i,depth:0,resolve:a.bind(null,s)},r)},modified:function(e){var i=e.oldIndex,s=e.newIndex,u=e.doc,c=h.splice(i,1)[0];h.splice(s,0,c);var f=l.splice(i,1)[0],d=n(t(u),f),p=d[0],v=d[1];l.splice(s,0,p),o({data:p,refs:v,subs:c,target:l,path:s,depth:0,resolve:a},r)},removed:function(e){var t=e.oldIndex;l.splice(t,1),i(h.splice(t,1)[0])}},b=f.onSnapshot(function(e){var t=e.docChanges;if(!s&&t.length){s=!0;var n=0,r=t.length,i=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));a=function(e){e.id in i&&++n>=r&&(p(u[c]),a=function(e){})}}t.forEach(function(e){v[e.type](e)}),t.length||a()},d);return function(){b(),h.forEach(i)}}({vm:u,key:c,collection:f,resolve:e,reject:a},r):function(e,n){var r=e.vm,o=e.key,u=e.document,c=e.resolve,f=e.reject,a=Object.create(null);c=function(e,t){var n;return function(){if(!n)return n=!0,e(t())}}(c,function(){return r[o]});var d=u.onSnapshot(function(e){e.exists?s({snapshot:t(e),target:r,path:o,subs:a,resolve:c},n):c()},f);return function(){d(),i(a)}}({vm:u,key:c,document:f,resolve:e,reject:a},r),u._firestoreUnbinds[c]=d})}e.default=function(e,t){var n=e.config.optionMergeStrategies;n.firestore=n.provide,e.mixin({created:function(){var e=this,t=this.$options.firestore;this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null);var n="function"==typeof t?t.call(this):t;n&&Object.keys(n).forEach(function(t){e.$bind(t,n[t])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype.$bind=function(e,t,n){this._firestoreUnbinds[e]&&this.$unbind(e);var r=u({vm:this,key:e,ref:t},n);return this.$firestoreRefs[e]=t,r},e.prototype.$unbind=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}},Object.defineProperty(e,"__esModule",{value:!0})});